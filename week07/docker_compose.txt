# docker-compose.yml 파일 생성
cat > docker-compose.yml << 'EOF'
version: '3.8'

services:
  # 웹 애플리케이션
  web:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./html:/usr/share/nginx/html:ro
    depends_on:
      - db
    networks:
      - app-net

  # 데이터베이스
  db:
    image: postgres:13
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: secret
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - app-net

  # Redis 캐시
  redis:
    image: redis:alpine
    networks:
      - app-net

volumes:
  db_data:

networks:
  app-net:
    driver: bridge
EOF

# HTML 파일 생성
mkdir html
cat > html/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head><title>Docker Compose Lab</title></head>
<body>
    <h1>Multi-Container Application</h1>
    <h3>Services Running:</h3>
    <ul>
        <li>Nginx Web Server (Port 8080)</li>
        <li>PostgreSQL Database</li>
        <li>Redis Cache</li>
    </ul>
    <p>Time: <span id="time"></span></p>
    <script>
        setInterval(() => {
            document.getElementById('time').textContent = new Date().toLocaleString();
        }, 1000);
    </script>
</body>
</html>
EOF

# 애플리케이션 시작
docker compose up -d

# 서비스 상태 확인
docker compose ps

# 로그 확인
docker compose logs web

# 브라우저에서 http://localhost:8080 확인

# 데이터베이스 연결 테스트
docker compose exec db psql -U admin -d myapp
# PostgreSQL 내부에서: \l (데이터베이스 목록), \q (종료)

# 서비스 스케일링
docker compose up -d --scale web=2

# 정리
docker compose down -v
